name: 'Deploy to Azure'
description: 'Deploys the application to Azure'
inputs:
  azure_credentials:
    description: 'Azure credentials'
    required: true
  environment:
    description: 'Deployment environment'
    required: true
  resource_group:
    description: 'Azure Resource Group'
    required: true
  cluster_name:
    description: 'AKS Cluster Name'
    required: true
runs:
  using: "composite"
  steps:
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.2.0'

    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure_credentials }}

    - name: Terraform Init
      run: terraform init
      working-directory: infrastructure/terraform
      shell: bash

    - name: Terraform Apply
      run: terraform apply -auto-approve
      working-directory: infrastructure/terraform
      shell: bash

    - name: Set up Kubectl
      uses: azure/setup-kubectl@v3

    - name: Get Kubeconfig
      run: |
        az aks get-credentials --resource-group ${{ inputs.resource_group }} --name ${{ inputs.cluster_name }} --overwrite-existing
      shell: bash

    - name: Create Kubernetes secret
      run: |
        kubectl create secret generic autopr-secrets \
          --from-literal=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
          --from-literal=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
          --from-literal=DATABASE_URL=${{ secrets.DATABASE_URL }} \
          --from-literal=REDIS_URL=${{ secrets.REDIS_URL }} \
          --dry-run=client -o yaml | kubectl apply -f -
      shell: bash

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f kubernetes/
      shell: bash
