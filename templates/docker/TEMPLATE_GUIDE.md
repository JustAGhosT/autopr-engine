# AutoPR Docker Template Guide

## Overview

This guide explains how to create and maintain Docker templates for the AutoPR template system. Docker templates follow
a structured YAML + template approach that enables flexible generation of Docker-related files.

## Template Structure

Each Docker template consists of two files:

1. `[template_name].dockerfile` - The actual Dockerfile template
2. `[template_name].dockerfile.yml` - Metadata and configuration for the template

## Template Metadata (YAML)

The YAML file defines metadata, variables, and configuration options for the template. Here's the complete schema with
detailed explanations:

### Required Fields

```yaml
# Basic template information (required)
name: "Node.js Dockerfile"  # Human-readable name
description: "Production-ready Dockerfile for Node.js applications"
category: "docker"  # Must be 'docker' for Docker templates
version: "1.0.0"    # Semantic version (MAJOR.MINOR.PATCH)
```

### Optional Metadata

```yaml
# Optional metadata
author: "AutoPR Team"
tags: ["docker", "nodejs", "production"]  # Searchable tags

# Template information
template_info:
  name: "Node.js Production Dockerfile"  # Display name in UI
  type: "containerization"               # Template type
  framework: "Node.js"                   # Primary framework/language
  target_audience: "DevOps engineers, developers"
  primary_use_cases:
    - "Production Node.js applications"
    - "API services"
    - "Microservices"
```

### Variables

Define configurable parameters for your template:

```yaml
# Variables that can be customized
variables:
  # Dropdown selection example
  node_version:
    type: "select"
    description: "Node.js version"
    options: ["18", "20", "lts/*"]
    default: "18"
    required: true

  # String input example
  base_image:
    type: "string"
    description: "Base Docker image"
    default: "node:${node_version}-alpine"  # Reference other variables
    required: true

  # Number input example
  exposed_port:
    type: "integer"
    description: "Port to expose"
    default: 3000
    min: 1024
    max: 65535

  # Boolean toggle example
  use_multi_stage:
    type: "boolean"
    description: "Use multi-stage build"
    default: true
```

### Template Variants

Define alternative versions of your template:

```yaml
# Template variants (optional)
variants:
  # PM2 variant
  with_pm2:
    name: "With PM2 Process Manager"
    description: "Includes PM2 for process management"
    modifications:
      # Add PM2 installation
      - line: 8
        action: "add_after"
        content: "RUN npm install -g pm2"
      # Replace CMD with PM2
      - line: -1
        action: "replace"
        content: "CMD [\"pm2-runtime\", \"start\", \"ecosystem.config.js\"]"

  # Development variant
  development:
    name: "Development Configuration"
    description: "Optimized for development with hot-reloading"
    modifications:
      - line: 6
        action: "replace"
        content: "RUN npm install"
      - line: -1
        action: "replace"
        content: "CMD [\"npm\", \"run\", \"dev\"]"
```

### Dependencies and Requirements

```yaml
# Required and optional files
dependencies:
  required:
    - "package.json"
  optional:
    - "ecosystem.config.js"
    - ".env"

# Supported platforms and versions
platforms:
  - name: "Docker"
    min_version: "20.10.0"
  - name: "Docker Compose"
    min_version: "2.0.0"
```

### Usage and Examples

```yaml
# Usage examples and notes
usage:
  - "Express.js applications"
  - "NestJS backends"
  - "Node.js API servers"

examples:
  - name: "Basic Usage"
    description: "Generate a standard Node.js Dockerfile"
    command: "autopr generate docker --template node"
  - name: "With PM2"
    description: "Generate with PM2 process manager"
    command: "autopr generate docker --template node --variant with_pm2"

# Additional notes and best practices
notes:
  - "For production, always use specific version tags (avoid 'latest')"
  - "Multi-stage builds reduce final image size"
  - "Include health checks for better container orchestration"
  - "Use .dockerignore to exclude unnecessary files"
```

## Template File

The `.dockerfile` template uses standard Dockerfile syntax with variable substitution:

```dockerfile
# {{ template_info.name }}
# Generated by AutoPR - DO NOT EDIT DIRECTLY

# Build stage
FROM {{ base_image }} AS builder
WORKDIR {{ working_directory | default("/app") }}

# Install dependencies
COPY package*.json ./
RUN npm ci --only=production

{% if use_multi_stage | default(true) %}
# Production stage
FROM {{ base_image }}
WORKDIR {{ working_directory | default("/app") }}

# Copy built assets from builder
COPY --from=builder /app/node_modules ./node_modules
{% endif %}

# Copy application code
COPY . .

# Expose port
EXPOSE {{ exposed_port | default(3000) }}

# Start command
CMD ["npm", "start"]
```

## Best Practices

### Variable Naming

- Use `snake_case` for variable names
- Be descriptive but concise
- Group related variables together

### Template Structure Best Practices

1. Start with a comment header
2. Define build stages (if multi-stage)
3. Install dependencies
4. Copy application code
5. Configure runtime settings
6. Define the start command

### Security Considerations

- Always pin versions in base images
- Use minimal base images (e.g., `-alpine` variants)
- Run as non-root user when possible
- Scan images for vulnerabilities

### Performance Optimization

- Leverage Docker layer caching
- Use `.dockerignore` to exclude unnecessary files
- Minimize the number of layers
- Clean up package manager caches in the same layer

## Testing Templates

1. **Lint your templates**:

   ```bash
   # Example using hadolint
   hadolint your-template.dockerfile
   ```

1. **Test variable substitution**:

   ```bash
   # Generate with test values
   autopr generate docker --template your-template --test
   ```

1. **Build test**:

   ```bash
   docker build -t test-image -f generated.Dockerfile .
   ```

## Versioning

Follow semantic versioning for your templates:

- **MAJOR**: Breaking changes
- **MINOR**: New features (backward compatible)
- **PATCH**: Bug fixes (backward compatible)

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add/update templates
4. Update documentation
5. Submit a pull request

## Examples

### Simple Node.js Template

**node.dockerfile.yml**:

```yaml
name: "Node.js Dockerfile"
description: "Simple Node.js Dockerfile"
category: "docker"
version: "1.0.0"

variables:
  node_version:
    type: "select"
    description: "Node.js version"
    options: ["18", "20"]
    default: "18"

  port:
    type: "integer"
    description: "Application port"
    default: 3000
```

**node.dockerfile**:

```dockerfile
FROM node:{{ node_version }}-alpine
WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE {{ port }}
CMD ["node", "server.js"]
```
